name: Update Homebrew Formula

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Download and hash binaries
        id: hashes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          BASE="https://github.com/${{ github.repository }}/releases/download/v${VERSION}"
          
          for target in x86_64-apple-darwin aarch64-apple-darwin x86_64-unknown-linux-gnu aarch64-unknown-linux-gnu; do
            FILE="leta-v${VERSION}-${target}.tar.gz"
            curl -sL "${BASE}/${FILE}" -o "${FILE}"
            SHA=$(sha256sum "${FILE}" | cut -d' ' -f1)
            NAME=$(echo "$target" | tr '-' '_')
            echo "${NAME}=${SHA}" >> $GITHUB_OUTPUT
          done

      - name: Update Homebrew formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          
          cat > leta.rb << EOF
          class Leta < Formula
            desc "LSP Enabled Tools for Agents - fast semantic code navigation"
            homepage "https://github.com/andreasjansson/leta"
            version "${VERSION}"
            license "MIT"

            on_macos do
              on_intel do
                url "https://github.com/andreasjansson/leta/releases/download/v${VERSION}/leta-v${VERSION}-x86_64-apple-darwin.tar.gz"
                sha256 "${{ steps.hashes.outputs.x86_64_apple_darwin }}"
              end
              on_arm do
                url "https://github.com/andreasjansson/leta/releases/download/v${VERSION}/leta-v${VERSION}-aarch64-apple-darwin.tar.gz"
                sha256 "${{ steps.hashes.outputs.aarch64_apple_darwin }}"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/andreasjansson/leta/releases/download/v${VERSION}/leta-v${VERSION}-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${{ steps.hashes.outputs.x86_64_unknown_linux_gnu }}"
              end
              on_arm do
                url "https://github.com/andreasjansson/leta/releases/download/v${VERSION}/leta-v${VERSION}-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${{ steps.hashes.outputs.aarch64_unknown_linux_gnu }}"
              end
            end

            def install
              bin.install "leta"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/leta --version")
            end
          end
          EOF
          
          git clone https://x-access-token:${GH_TOKEN}@github.com/andreasjansson/homebrew-tap.git
          cp leta.rb homebrew-tap/Formula/leta.rb
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/leta.rb
          git commit -m "Update leta to ${VERSION}"
          git push
