#!/usr/bin/env python3
"""Split integration tests into per-language files."""

import re
import sys
from pathlib import Path

SCRIPT_DIR = Path(__file__).parent
PROJECT_DIR = SCRIPT_DIR.parent
SRC_FILE = PROJECT_DIR / "test" / "test_integration.py"
DEST_DIR = PROJECT_DIR / "test" / "integration"

CLASS_MAP = {
    "TestPythonIntegration": "test_python.py",
    "TestGoIntegration": "test_go.py",
    "TestRustIntegration": "test_rust.py",
    "TestTypeScriptIntegration": "test_typescript.py",
    "TestJavaIntegration": "test_java.py",
    "TestMultiLanguageIntegration": "test_multi_language.py",
    "TestCppIntegration": "test_cpp.py",
    "TestZigIntegration": "test_zig.py",
    "TestLuaIntegration": "test_lua.py",
    "TestRubyIntegration": "test_ruby.py",
    "TestPhpIntegration": "test_php.py",
}

def find_class_boundaries(lines: list[str]) -> dict[str, tuple[int, int]]:
    """Find start and end lines for each test class."""
    boundaries = {}
    class_pattern = re.compile(r'^class (Test\w+):')
    
    class_starts = []
    for i, line in enumerate(lines):
        match = class_pattern.match(line)
        if match:
            class_starts.append((i, match.group(1)))
    
    for idx, (start, name) in enumerate(class_starts):
        if idx + 1 < len(class_starts):
            end = class_starts[idx + 1][0] - 1
            # Walk back to skip blank lines and comment separators
            while end > start and (lines[end].strip() == '' or lines[end].startswith('# =')):
                end -= 1
            end += 1  # Include the last non-blank line
        else:
            end = len(lines)
        boundaries[name] = (start, end)
    
    return boundaries

def find_common_end(lines: list[str], boundaries: dict) -> int:
    """Find where common code ends (before first test class)."""
    first_class_line = min(start for start, _ in boundaries.values())
    # Walk back to skip blank lines and separators
    end = first_class_line - 1
    while end > 0 and (lines[end].strip() == '' or lines[end].startswith('# =')):
        end -= 1
    return end + 1

def main():
    DEST_DIR.mkdir(exist_ok=True)
    
    content = SRC_FILE.read_text()
    lines = content.splitlines()
    
    boundaries = find_class_boundaries(lines)
    common_end = find_common_end(lines, boundaries)
    
    # Extract common code to conftest.py
    common_code = '\n'.join(lines[:common_end])
    (DEST_DIR / "conftest.py").write_text(common_code + '\n')
    print(f"Extracted common code (lines 1-{common_end}) to conftest.py")
    
    # Extract each class
    for class_name, filename in CLASS_MAP.items():
        if class_name not in boundaries:
            print(f"Warning: {class_name} not found in source file")
            continue
        
        start, end = boundaries[class_name]
        class_code = '\n'.join(lines[start:end])
        (DEST_DIR / filename).write_text(class_code + '\n')
        print(f"Extracted {class_name} (lines {start+1}-{end}) to {filename}")
    
    # Create __init__.py
    (DEST_DIR / "__init__.py").write_text("")
    
    print(f"\nDone! Files created in {DEST_DIR}/")
    print("Now manually add imports to each test file.")

if __name__ == "__main__":
    main()
